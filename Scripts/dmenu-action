#!/bin/bash

# Get - Select one of available actions for dmenu from these below
Get() { # {{{
  actions="Run program\nSearch in google\nOpen url\nTranslate\nTake screenshot\nAutotype password"

  if [[ -n "$1" ]]; then
    choice="$1"
  else
    choice="$(DGet -p "Select action" -o "$actions")"
  fi

  case $choice in
    *pass*)        Password  ;;
    [Rr]un*)       DGet -mrp "Run program" ;;
    [Ss]earch*)    Google    ;;
    [Oo]pen*|*url) Web       ;;
    [Tt]rans*)     Translate ;;
    *screen*)      Screen    ;;
  esac
}
# }}}

# Actions -----------------------------------------------------------------

# DGet - Run dmenu or dmenu_run with specific options
DGet() { # {{{
  local arg prompt options multiline run settings geometry

  # Get options
  while getopts 'mro:p:' arg; do
    case $arg in
      p) prompt="$OPTARG" ;;
      o) options="$OPTARG" ;;
      m) multiline=1 ;;
      r) run=1 ;;
      *) return 1
    esac
  done

  # Set dmenu arguments
  settings="-i -nb #000000 -nf #9e9e9e -sb #0087af -sf #000000"

  if [[ -n "$multiline" ]]; then
    geometry="-x 45 -w 300 -l 20"
  else
    geometry="-x 45 -w 800"
  fi

  # Run dmenu
  [[ -n "$run" ]] && dmenu_run -p "$prompt" $geometry $settings && return

  echo $(printf "$options" | dmenu -p "$prompt" $geometry $settings)
}
# }}}

# Screen - Take screenshot with scrot
Screen() { # {{{
  options="Fullscreen\nDelayed fullscreen\nSection"

  choice=$(DGet -p "Take screenshot" -o "$options")

  dir="$HOME/Dropbox"
  mkdir -p "$dir" && cd "$dir"

  case $choice in
    Fullscreen)          scrot -d 1 && notify-send 'Taken fullscreen screenshot' ;;
    Delayed?fullscreen)  scrot -d 5 && notify-send 'Taken fullscreen screenshot' ;;
    Section)             scrot -s   && notify-send 'Taken screenshot of selected secion' ;;
  esac
}
# }}}

# Google - Search specified text in google with firefox
Google() { # {{{
  opt=$(DGet -p "Search in google")

  [[ -n "$opt" ]] && firefox 'http://www.google.com/search?q='"$opt"
}
# }}}

# Web - Open specified url in firefox
Web() { # {{{
  opt=$(DGet -p "Open url")

  [[ -n "$opt" ]] && firefox "$opt"
}
# }}}

# Translate - Translate specified text from and to selected languages
Translate() { # {{{
  # Languages
  languages="auto\naf afrikaans\nsq albanian\nar arabic\naz azerbaijani\neu basque\nbn bengali\nbe belarusian\nbg bulgarian\nca catalan\nzh-cn chinese simplified\nzh-tw chinese traditional\nhr croatian\ncs czech\nda danish\nnl dutch\nen english\neo esperanto\net estonian\ntl filipino\nfi finnish\nfr french\ngl galician\nka georgian\nde german\nel greek\ngu gujarati\nht haitian creole\niw hebrew\nhi hindi\nhu hungarian\nis icelandic\nid indonesian\nga irish\nit italian\nja japanese\nkn kannada\nko korean\nla latin\nlv latvian\nlt lithuanian\nmk macedonian\nms malay\nmt maltese\nno norwegian\nfa persian\npl polish\npt portuguese\nro romanian\nru russian\nsr serbian\nsk slovak\nsl slovenian\nes spanish\nsw swahili\nsv swedish\nta tamil\nte telugu\nth thai\ntr turkish\nuk ukrainian\nur urdu\nvi vietnamese\ncy welsh\nyi yiddish"

  sl=$(DGet -mp "Source language" -o "$languages")
  [[ -z "$sl" ]] && return

  tl=$(DGet -mp "Target language" -o "$languages")
  [[ -z "$tl" ]] && return

  slong="${sl##* }"; sshort="${sl%% *}"
  tlong="${tl##* }"; tshort="${tl%% *}"

  # Text to translate
  text=$(DGet -p "Translate $slong to $tlong")

  [[ -z "$text" ]] && return

  # Translation
  if ! hash translate 2>/dev/null; then
    firefox 'http://www.translate.google.com/?'"&sl=${sl%% *}&tl=${tl%% *}&text=$opt"
  else
    translation="$(translate "{$sshort=$tshort}" "$text")"
    notify-send "Translated from $slong to $tlong" "\n<b>Original text:</b>\n$text\n\n<b>Translation:</b>\n$translation"
  fi
}
# }}}

# Password - Autotype selected password into focused window
Password() { # {{{
  # Autotyping method
  option="$(DGet -p "Select autotype method" -o "Tab after username\nReturn after username\nNo username")"
  [[ ! "$option" =~ ^(Tab .*|Return .*|No username)$ ]] && return

  # Select password
  candidates="$(find "$PASSWORD_STORE_DIR" -name '*gpg' -print | sed "s,$PASSWORD_STORE_DIR/,,;s,\.gpg\$,,")"
  choice=$(DGet -mp "Select password" -o "$(printf "$candidates" | sort)")
  [[ -z "$choice" ]] && return

  output="$(pass "$choice")"
  exit_code="$?"
  (( exit_code  > 0 )) && return

  # Set variables
  password="$(printf "%s" "$output" | head -n 1)"
  username="$(printf "%s" "$output" | grep '^username: ' | cut -c 11-)"

  # Autotype
  if [[ -n "$password" ]]; then
    if [[ -n "$username" && "$option" != "No username" ]]; then
      xdotool type "$username"
      xdotool key "${option%% *}"
    fi

    xdotool type "$password"
    xdotool key "Return"
  fi
}
# }}}

# -------------------------------------------------------------------------

Get "$1"
