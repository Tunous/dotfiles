#!/bin/bash

# {{{ Functions

DGet() {
  if [[ -z "$2" ]]; then
    echo $(dmenu -nb "#000000" -nf "#9e9e9e" -sb "#0087af" -sf "#000000" -p "$1" -i)
  else
    echo $(printf "$2" | dmenu -nb "#000000" -nf "#9e9e9e" -sb "#0087af" -sf "#000000" -p "$1" -i)
  fi
}

Screen() {
  options="Fullscreen\nDelayed fullscreen\nSection"

  opt=$(DGet "Take screenshot" "$options")

  dir="$HOME/Dropbox"
  cd $dir

  case $opt in
    Fullscreen)          scrot -d 1 && notify-send 'Taken fullscreen screenshot' ;;
    Delayed?fullscreen)  scrot -d 5 && notify-send 'Taken fullscreen screenshot' ;;
    Section)             scrot -s   && notify-send 'Taken screenshot of selected secion' ;;
  esac
}

Google() {
  opt=$(DGet "Search in google")

  [[ -n "$opt" ]] && firefox 'http://www.google.com/search?q='"$opt"
}

Web() {
  opt=$(DGet "Open url")

  [[ -n "$opt" ]] && firefox "$opt"
}

Translate() {
  languages="auto\naf afrikaans\nsq albanian\nar arabic\naz azerbaijani\neu basque\nbn bengali\nbe belarusian\nbg bulgarian\nca catalan\nzh-cn chinese simplified\nzh-tw chinese traditional\nhr croatian\ncs czech\nda danish\nnl dutch\nen english\neo esperanto\net estonian\ntl filipino\nfi finnish\nfr french\ngl galician\nka georgian\nde german\nel greek\ngu gujarati\nht haitian creole\niw hebrew\nhi hindi\nhu hungarian\nis icelandic\nid indonesian\nga irish\nit italian\nja japanese\nkn kannada\nko korean\nla latin\nlv latvian\nlt lithuanian\nmk macedonian\nms malay\nmt maltese\nno norwegian\nfa persian\npl polish\npt portuguese\nro romanian\nru russian\nsr serbian\nsk slovak\nsl slovenian\nes spanish\nsw swahili\nsv swedish\nta tamil\nte telugu\nth thai\ntr turkish\nuk ukrainian\nur urdu\nvi vietnamese\ncy welsh\nyi yiddish"

  sl=$(DGet "Source language" "$languages")
  [[ -z "$sl" ]] && return

  tl=$(DGet "Target language" "$languages")
  [[ -z "$tl" ]] && return

  opt=$(DGet "Translate ${sl##* } to ${tl##* }")

  [[ -n "$opt" ]] && firefox 'http://www.translate.google.com/?'"&sl=${sl%% *}&tl=${tl%% *}&text=$opt"
}

Password() {
  option="$(DGet "Select way of autotyping password" "Tab after username\nReturn after username\nNo username")"
  [[ ! "$option" =~ ^(Tab .*|Return .*|No username)$ ]] && return

  candidates="$(find "$PASSWORD_STORE_DIR" -name '*gpg' -print | sed "s,$PASSWORD_STORE_DIR/,,;s,\.gpg\$,,")"

  choice=$(DGet "Select password" "$(printf "$candidates" | sort)")
  [[ -z "$choice" ]] && return

  output="$(pass "$choice")"

  exit_code="$?"
  (( exit_code  > 0 )) && return

  password="$(printf "%s" "$output" | head -n 1)"
  username="$(printf "%s" "$output" | grep '^username: ' | cut -c 11-)"

  if [[ -n "$password" ]]; then
    if [[ -n "$username" && "$option" != "No username" ]]; then
      xdotool type "$username"
      xdotool key "${option%% *}"
    fi

    xdotool type "$password"
    xdotool key "Return"
  fi
}

# }}}

options="Run program\nSearch in google\nOpen url\nTranslate\nTake screenshot\nAutotype password"

action=$(DGet "Choose action" "$options")

case $action in
  Run?program) dmenu_run -nb "#000000" -nf "#9e9e9e" -sb "#0087af" -sf "#000000" -p "Run program" ;;
  Search?in?google) Google ;;
  Open?url) Web ;;
  Translate) Translate ;;
  Take?screenshot) Screen ;;
  Autotype?password) Password ;;
esac
