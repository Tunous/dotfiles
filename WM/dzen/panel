#! /bin/bash

# Init {{{


if [ $(pgrep -cx panel) -gt 1 ] ; then
  printf "%s\n" "The panel is already running." >&2
  exit 1
fi

trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

. $HOME/dotfiles/WM/dzen/common.sh


# }}}
# Fifo {{{


FIFO=/tmp/panel-fifo
[ -e "$FIFO" ] && rm "$FIFO"
mkfifo "$FIFO"
exec 3<> "$FIFO"


# }}}
# Variables {{{


NORMIFS=$IFS
FIELDIFS=':'

PANEL_HEIGHT=15
EVENTS=''

bspc config top_padding $PANEL_HEIGHT


# }}}
# Functions {{{

Time() { #{{{
  printf "%s" "$(Icon clock) $(date +%H:%M:%S)"
}

# }}}
Volume() { #{{{
  vol=$(amixer get Master | egrep -o "[0-9]+%" | egrep -o "[0-9]*")
  mut=$(amixer get Master | egrep 'Playback.*?\[o' | egrep -o '\[o.+\]')

  if [ $vol -eq 0 ]; then
    ico="$(Icon volume0)"
  elif [ $vol -eq 100 ]; then
    ico="$(Icon volume100)"
  elif [ $vol -lt 100 ] && [ $vol -gt 60 ]; then
    ico="$(Icon volume75)"
  elif [ $vol -le 60 ] && [ $vol -gt 30 ]; then
    ico="$(Icon volume50)"
  elif [ $vol -le 30 ] && [ $vol -gt 0 ]; then
    ico="$(Icon volume25)"
  fi

  [ "$mut" = "[off]" ] && ico="$(Icon volume0)"

  printf "^ca(1,$(Script volume.sh)) $ico ^ca()"
}

# }}}
Menu() { # {{{
  printf "^ca(1,$(Script menu.sh)) $(Icon arch blue)  ^ca()"
}

# }}}

# }}}

# Updating {{{


bspc control --subscribe >&3 &
xtitle -sf 'T%s' >&3 &
while :; do
  echo "S$(Time)" >&3
  sleep 3
done &


# }}}
# Printing {{{

while read -r line <&3; do
  case $line in
    S*)
      TIME="$(Align right -140; Volume; Separate) ${line#?}"
      ;;
    T*)
      TITLE="$(Align left; Menu) ${line#?}"
      ;;
    W*)
      # bspwm internal state
      DESK=" $(Align center -147) "
      IFS=$FIELDIFS
      set -- ${line#?}

      while [ $# -gt 0 ] ; do
        item=$1
        name=${item#?}
        icon=" â€¢ "
        [ "$name" = Float ] && icon="$name"

        case $item in
          [OoFfUu]*)
            case $item in
              [OFU]*) # Focused desktop
                FG=$(Color White)
                ;;

              o*) # Occupied desktop
                FG=$(Color Foreground)
                ;;

              f*) # Free desktop
                FG=$(Color Selection)
                ;;

              u*) # Urgent desktop
                FG=$(Color Yellow)
                ;;
            esac

            DESK="${DESK}^fg($FG)^ca(1, bspc desktop -f ${name})^ca(2, bspc window -d ${name}) ${icon} ^ca()^ca()^fg()"
            ;;
        esac
        shift
      done
      IFS=$NORMIFS
      ;;
  esac

  echo "$TITLE $DESK $TIME"
done | dzen2 -h "$PANEL_HEIGHT" -ta l -bg "$(Color black)" -e "$EVENTS" &

# }}}

wait
